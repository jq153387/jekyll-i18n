{% assign page = include.obj %}

{% if site.lang.first %}
  {% assign page_lang = page.lang | default: site.lang[0] %}
  {% assign default_lang = site.lang[0] %}
{% else %}
  {% assign page_lang = page.lang | default: site.lang | default: "en" %}
  {% assign default_lang = site.lang | default: "en" %}
{% endif %}

{% assign lang_suffix = page_lang | prepend: "_" %}
{% assign collection_suffix = page.collection | slice: -3, 3 %}
{% if collection_suffix == lang_suffix %}
  {% assign collection_baselength = page.collection.size | minus: 3 %}
  {% assign collection_basename = page.collection | slice: 0, collection_baselength %}
{% else %}
  {% assign collection_basename = page.collection %}
{% endif %}

{% assign translated_collections = "" | split: "," %}
{% for lang in site.lang %}
  {% if forloop.first %}
    {% comment %} First lang collections are the default and have no "_lang" suffix {% endcomment %}
    {% assign collection_testname = collection_basename %}
  {% else %}
    {% assign collection_testname = collection_basename | append: "_" | append: lang %}
  {% endif %}
  {% unless collection_testname == page.collection %}
    {% assign collection_testobj = site.collections | where: "label", collection_testname | first %}
    {% if collection_testobj.output == true %}
      {% assign translated_collections = translated_collections | push: collection_testname %}
    {% endif %}
  {% endunless %}
{% endfor %}

{% if page.content_id %}
  {% assign content_id_first_character = page.content_id | slice: 0 %}
  {% if content_id_first_character != "/" %}
    {% assign content_id = page.content_id | prepend: "/" %}
  {% else %}
    {% assign content_id = page.content_id %}
  {% endif %}
{% else %}
  {% assign path_in_collection = page.path | remove_first: "_" | remove_first: page.collection %}
  {% assign filename = path_in_collection | split: "/" | last %}
  {% assign base_content_id_length = path_in_collection | size | minus: filename.size %}
  {% assign content_id = path_in_collection | slice: 0, base_content_id_length | append: page.slug %}
{% endif %}

{% assign translated_pages = "" | split: "," %}
{% comment %} check every sibling collection {% endcomment %}
{% for translated_collection in translated_collections %}

  {% comment %} check every document in the sibling collection {% endcomment %}
  {% for document in site[translated_collection] %}
  
    {% comment %} get content_id {% endcomment %}
    {% if document.content_id %}
      {% assign test_content_id_first_character = document.content_id | slice: 0 %}
      {% if test_content_id_first_character != "/" %}
        {% assign test_content_id = document.content_id | prepend: "/" %}
      {% else %}
        {% assign test_content_id = document.content_id %}
      {% endif %}
    {% else %}
      {% assign test_path_in_collection = document.path | remove_first: "_" | remove_first: document.collection %}
      {% assign test_filename = test_path_in_collection | split: "/" | last %}
      {% assign test_base_content_id_length = test_path_in_collection | size | minus: test_filename.size %}
      {% assign test_content_id = test_path_in_collection | slice: 0, test_base_content_id_length | append: document.slug %}
    {% endif %}
    
    {% if test_content_id == content_id %}
      {% assign translated_pages = translated_pages | push: document %}
    {% endif %}
    
  {% endfor %}
  
{% endfor %}

{% assign fallback_translation = translated_pages | where: "lang", default_lang | first %}
